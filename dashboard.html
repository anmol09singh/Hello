<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Food Bridge</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <div class="logo">
                <h1>🍽️ Food Bridge</h1>
            </div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link active">Dashboard</a>
                <a href="ngo-finder.html" class="nav-link">Find NGOs</a>
                <a href="feed.html" class="nav-link">Feed</a>
                <a href="chat.html" class="nav-link">Messages <span id="unreadBadge" class="badge"></span></a>
                <a href="profile.html" class="nav-link">Profile</a>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div class="welcome-section">
            <h2>Welcome, <span id="userName"></span>! 👋</h2>
            <p class="user-type-badge" id="userTypeBadge"></p>
        </div>

        <div class="dashboard-grid">
            <div class="dashboard-card">
                <div class="card-icon">📍</div>
                <h3>Find NGOs Near You</h3>
                <p>Discover NGOs in your area and connect with them</p>
                <a href="ngo-finder.html" class="btn-primary">Explore Map</a>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">📱</div>
                <h3>Community Feed</h3>
                <p>Share donations, stories, and fundraising campaigns</p>
                <a href="feed.html" class="btn-primary">View Feed</a>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">💬</div>
                <h3>Messages</h3>
                <p>Chat with donors and NGOs in real-time</p>
                <a href="chat.html" class="btn-primary">Open Chat</a>
            </div>

            <div class="dashboard-card">
                <div class="card-icon">👤</div>
                <h3>Your Profile</h3>
                <p>Update your information and preferences</p>
                <a href="profile.html" class="btn-primary">Edit Profile</a>
            </div>
        </div>

        <div class="stats-section">
            <h3>Quick Stats</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="ngoCount">0</div>
                    <div class="stat-label">Registered NGOs</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="postCount">0</div>
                    <div class="stat-label">Community Posts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="donorCount">0</div>
                    <div class="stat-label">Active Donors</div>
                </div>
            </div>
        </div>

        <div class="recent-activity">
            <h3>Recent Activity</h3>
            <div id="recentPosts" class="activity-list"></div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        // Check authentication
        checkAuth();

        // Load dashboard data
        async function loadDashboard() {
            const user = await getCurrentUser();
            if (!user) return;

            document.getElementById('userName').textContent = user.full_name;
            document.getElementById('userTypeBadge').textContent = user.user_type.toUpperCase();

            // Load stats
            const { data: ngos } = await supabase.from('ngo_profiles').select('id');
            const { data: posts } = await supabase.from('posts').select('id');
            const { data: donors } = await supabase.from('users').select('id').eq('user_type', 'donor');

            document.getElementById('ngoCount').textContent = ngos?.length || 0;
            document.getElementById('postCount').textContent = posts?.length || 0;
            document.getElementById('donorCount').textContent = donors?.length || 0;

            // Load recent posts
            const { data: recentPosts } = await supabase
                .from('posts')
                .select(`
                    *,
                    users (full_name, user_type)
                `)
                .order('created_at', { ascending: false })
                .limit(5);

            const recentPostsEl = document.getElementById('recentPosts');
            if (recentPosts && recentPosts.length > 0) {
                recentPostsEl.innerHTML = recentPosts.map(post => `
                    <div class="activity-item">
                        <div class="activity-icon">${getPostTypeIcon(post.post_type)}</div>
                        <div class="activity-content">
                            <h4>${post.title}</h4>
                            <p>by ${post.users.full_name} • ${formatDate(post.created_at)}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                recentPostsEl.innerHTML = '<p class="text-muted">No recent activity</p>';
            }

            // Check for unread messages
            checkUnreadMessages();
        }

        function getPostTypeIcon(type) {
            const icons = {
                donation: '🍽️',
                fundraising: '💰',
                story: '📖',
                general: '📢'
            };
            return icons[type] || '📝';
        }

        loadDashboard();
    </script>
</body>
</html>