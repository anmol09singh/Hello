<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Food Bridge</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <nav class="navbar navbar-dark">
        <div class="container">
            <div class="logo">
                <h1>üçΩÔ∏è Food Bridge</h1>
            </div>
            <div class="nav-links">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
                <a href="ngo-finder.html" class="nav-link">Find NGOs</a>
                <a href="feed.html" class="nav-link">Feed</a>
                <a href="chat.html" class="nav-link">Messages</a>
                <a href="profile.html" class="nav-link active">Profile</a>
                <button class="btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="container main-content">
        <div class="profile-container">
            <div class="profile-header">
                <div class="profile-avatar">
                    <span id="profileInitial"></span>
                </div>
                <div class="profile-info">
                    <h2 id="profileName"></h2>
                    <p id="profileType" class="user-type-badge"></p>
                    <p id="profileEmail" class="text-muted"></p>
                </div>
            </div>

            <div class="profile-content">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab('details')">Profile Details</button>
                    <button class="tab-btn" onclick="switchTab('posts')">My Posts</button>
                </div>

                <div id="detailsTab" class="tab-content">
                    <form id="updateProfileForm">
                        <div class="form-group">
                            <label>Full Name</label>
                            <input type="text" id="fullName" required>
                        </div>
                        <div class="form-group" id="orgNameGroup">
                            <label>Organization Name</label>
                            <input type="text" id="orgName">
                        </div>
                        <div class="form-group">
                            <label>Phone</label>
                            <input type="tel" id="phone" required>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="address" required>
                        </div>
                        <div class="form-group" id="descriptionGroup">
                            <label>About</label>
                            <textarea id="description" rows="4"></textarea>
                        </div>
                        <div class="form-group" id="operatingHoursGroup">
                            <label>Operating Hours</label>
                            <input type="text" id="operatingHours" placeholder="e.g., Mon-Fri 9AM-5PM">
                        </div>
                        <button type="submit" class="btn-primary">Update Profile</button>
                    </form>
                </div>

                <div id="postsTab" class="tab-content" style="display: none;">
                    <div id="myPosts" class="my-posts"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script>
        checkAuth();

        let currentUser = null;
        let userProfile = null;

        async function loadProfile() {
            currentUser = await getCurrentUser();
            if (!currentUser) return;

            document.getElementById('profileName').textContent = currentUser.full_name;
            document.getElementById('profileType').textContent = currentUser.user_type.toUpperCase();
            document.getElementById('profileEmail').textContent = currentUser.email;
            document.getElementById('profileInitial').textContent = currentUser.full_name.charAt(0).toUpperCase();

            // Load form
            document.getElementById('fullName').value = currentUser.full_name;
            document.getElementById('phone').value = currentUser.phone || '';

            // Load profile based on type
            if (currentUser.user_type === 'ngo') {
                const { data } = await supabase
                    .from('ngo_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                userProfile = data;
                if (data) {
                    document.getElementById('orgName').value = data.organization_name || '';
                    document.getElementById('address').value = data.address || '';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('operatingHours').value = data.operating_hours || '';
                }
                document.getElementById('operatingHoursGroup').style.display = 'block';
            } else {
                const { data } = await supabase
                    .from('donor_profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                userProfile = data;
                if (data) {
                    document.getElementById('orgName').value = data.organization_name || '';
                    document.getElementById('address').value = data.address || '';
                }
                document.getElementById('descriptionGroup').style.display = 'none';
                document.getElementById('operatingHoursGroup').style.display = 'none';
            }
        }

        document.getElementById('updateProfileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const fullName = document.getElementById('fullName').value;
            const phone = document.getElementById('phone').value;

            // Update user table
            const { error: userError } = await supabase
                .from('users')
                .update({ full_name: fullName, phone: phone })
                .eq('id', currentUser.id);

            if (userError) {
                hideLoading();
                showNotification('Error updating profile', 'error');
                return;
            }

            // Update profile table
            const profileData = {
                organization_name: document.getElementById('orgName').value,
                address: document.getElementById('address').value
            };

            if (currentUser.user_type === 'ngo') {
                profileData.description = document.getElementById('description').value;
                profileData.operating_hours = document.getElementById('operatingHours').value;

                await supabase
                    .from('ngo_profiles')
                    .update(profileData)
                    .eq('user_id', currentUser.id);
            } else {
                await supabase
                    .from('donor_profiles')
                    .update(profileData)
                    .eq('user_id', currentUser.id);
            }

            hideLoading();
            showNotification('Profile updated successfully!');
            setTimeout(() => location.reload(), 1500);
        });

        async function loadMyPosts() {
            const { data: posts } = await supabase
                .from('posts')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            const postsContainer = document.getElementById('myPosts');
            if (posts && posts.length > 0) {
                postsContainer.innerHTML = posts.map(post => `
                    <div class="post-card">
                        <div class="post-header">
                            <h4>${post.title}</h4>
                            <span class="post-type-badge">${getPostTypeLabel(post.post_type)}</span>
                        </div>
                        <p>${post.content}</p>
                        ${post.image_url ? `<img src="${post.image_url}" alt="Post image" class="post-image">` : ''}
                        <div class="post-footer">
                            <span>‚ù§Ô∏è ${post.likes_count} likes</span>
                            <span>${formatDate(post.created_at)}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                postsContainer.innerHTML = '<p class="text-muted text-center">No posts yet</p>';
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.style.display = 'none');

            event.target.classList.add('active');
            
            if (tab === 'details') {
                document.getElementById('detailsTab').style.display = 'block';
            } else {
                document.getElementById('postsTab').style.display = 'block';
                loadMyPosts();
            }
        }

        function getPostTypeLabel(type) {
            const labels = {
                donation: 'üçΩÔ∏è Donation',
                fundraising: 'üí∞ Fundraising',
                story: 'üìñ Story',
                general: 'üì¢ General'
            };
            return labels[type] || type;
        }

        loadProfile();
    </script>
</body>
</html>